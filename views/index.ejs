<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Solo cùng bolero</title>
    <meta name="description" content="Node.js image upload using express, jQuery using ajax."/>
    <script src="/public/jquery-3.2.1.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="/socket.io/socket.io.js"></script>
    <script src="/public/xuly.js"></script>
    <link rel="stylesheet" type="text/css" href="/public/layout.css"/>
</head>
<body>
<br><br>
<div class="container">
    <div id="wrapper" class="col-md-12">
        <div id="loginForm">
            <h3>NHẬP TÊN CỦA MÀY VÀO ?</h3>
            <input class="form-control" type="text" id="txtUsername"/><br>
            <input class="btn btn-default" type="button" value="Register" id="btnRegister"/>
        </div>
        <div id="chatForm">
            <div class="col-md-2 ">
                <div id="left" class="panel panel-default">
                    <div id="boxTitle" class="panel-heading">Bọn ngu</div>
                    <div class="panel-body" id="boxContent"></div>
                </div>
            </div>
            <div class="col-md-7">
                <div id="right">
                    <div class="row">
                        <div class="col-md-12" align="right" id="sayHi">
                            Hello <span id="currentUser">Teo</span>
                            <input type="button" class="btn btn-danger" id="btnLogout" value="Logout">
                        </div>
                    </div>
                    <hr>
                    <input class="form-control" type="text" id="txtMessage"/><br>
                    <input type="button" class="btn btn-success" style="display: none" id="btnSendMessage" value="Gửi"/>
                    <div class="col-md-6" align="left" id="thongbao"></div>
                    <hr>
                    <div style="height: auto" id="listMessages">

                    </div>


                </div>
            </div>
            <div class="col-md-3">
                <!-- Photos upload Form -->
                <form id="upload-photos" method="post" action="/upload_photos" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="photos-input">Gửi file</label>
                        <input id="photos-input" type="file" name="photos[]" multiple="multiple">
                        <p class="help-block">File sẽ được gửi đi ngay lập tức sau khi nhấn nút gửi. Dữ liệu của file
                            dưới 300MB</p>
                    </div>
                    <input type="hidden" name="csrf_token" value="just_a_text_field"/>
                    <input class="btn btn-default" type="submit" name="Photo Uploads" value="Send luôn"/>
                </form>
                <br/>
                <!-- Progress Bar -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0"
                                 aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                                <span class="sr-only"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="album" class="row"></div>
                <br/><br/>
            </div>
        </div>

    </div>


</div>

<script>
    /**
     * Upload the photos using ajax request.
     *
     * @param formData
     */
    function uploadFiles(formData) {
        $.ajax({
            url: '/upload_photos',
            method: 'post',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function () {
                var xhr = new XMLHttpRequest();

                // Add progress event listener to the upload.
                xhr.upload.addEventListener('progress', function (event) {
                    var progressBar = $('.progress-bar');

                    if (event.lengthComputable) {
                        var percent = (event.loaded / event.total) * 100;
                        progressBar.width(percent + '%');

                        if (percent === 100) {
                            progressBar.removeClass('active');
                        }
                    }
                });

                return xhr;
            }
        }).done(handleSuccess).fail(function (xhr, status) {
            alert(status);
        });
    }

    /**
     * Handle the upload response data from server and display them.
     *
     * @param data
     */
    function handleSuccess(data) {
        if (data.length > 0) {
            var html = '';
            for (var i = 0; i < data.length; i++) {
                var img = data[i];

                if (img.status) {
                    html += '<div class="col-xs-12 col-md-12"><a href="/download?name="' + img.filename + ' class="thumbnail"><img src="' + img.publicPath + '" alt="' + img.filename + '"></a></div>';
                } else {
                    html += '<div class="col-xs-12 col-md-12"><a href="/download?name="' + img.filename + ' class="thumbnail">' + img.filename + '</a></div>';
                }
            }

            $('#album').html(html);
        } else {
            alert('No images were uploaded.')
        }
    }

    // Set the progress bar to 0 when a file(s) is selected.
    $('#photos-input').on('change', function () {
        $('.progress-bar').width('0%');
    });


    // On form submit, handle the file uploads.
    $('#upload-photos').on('submit', function (event) {
        event.preventDefault();

        // Get the files from input, create new FormData.
        var files = $('#photos-input').get(0).files,
            formData = new FormData();

        if (files.length === 0) {
            alert('Select atleast 1 file to upload.');
            return false;
        }

        if (files.length > 1) {
            alert('You can only upload up to 3 files.');
            return false;
        }

        // Append the files to the formData.
        for (var i = 0; i < files.length; i++) {
            var file = files[i];
            socket.emit("user-send-message", '<a href="/download?name=' + file.name + '" class="thumbnail">' + file.name + '</a>');
            formData.append('photos[]', file, file.name);
        }

        // Note: We are only appending the file inputs to the FormData.
        uploadFiles(formData);
    });


</script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>
</body>
</html>